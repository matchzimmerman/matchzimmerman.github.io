<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAGPIE | Bunker Ops — Audio v4 (robust render)</title>
  <style>
    :root{ --amber:#ff9d2e; --amber-hi:#ffb347; --grid:#78ff78; --ui:#ff9d2e; --bg:#000; }
    html,body{height:100%;margin:0;background:#000;color:var(--ui);font:12px/1.25 ui-monospace, monospace;}
    #wrap{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto;min-height:100vh;}
    #stage{position:relative;background:#000;min-height:420px;cursor:crosshair;}
    canvas{position:absolute;inset:0;width:100%;height:100%;image-rendering:pixelated;}
    #scanlines{pointer-events:none;background:repeating-linear-gradient(to bottom, rgba(255,157,46,0.05) 0 2px, rgba(0,0,0,0) 2px 4px);}  
    #hints{position:absolute;left:12px;top:12px;opacity:.85}
    #credits{position:absolute;right:10px;bottom:10px;opacity:.55}
    #panel{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:10px 14px;border-top:1px solid rgba(255,157,46,.25);background:linear-gradient(180deg, rgba(255,157,46,.06), rgba(0,0,0,.5));}
    .group{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="range"]{accent-color:var(--amber);width:140px}
    button{background:transparent;color:var(--amber);border:1px solid var(--amber);padding:6px 10px;border-radius:6px;cursor:pointer}
    button:hover{filter:brightness(1.2)}
    .win{position:absolute;min-width:240px;max-width:46vw;min-height:120px;background:rgba(0,0,0,0.85);border:1px solid rgba(255,157,46,.35);box-shadow:0 0 0 1px rgba(255,157,46,.12) inset;user-select:none;}
    .title{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,157,46,.25);padding:6px 8px;background:linear-gradient(180deg, rgba(255,157,46,.08), rgba(0,0,0,.2));cursor:grab}
    .title.dragging{cursor:grabbing}
    .body{padding:8px;max-height:45vh;overflow:auto}
    #cmd{position:fixed;left:50%;top:14%;transform:translateX(-50%);width:min(720px,86vw);background:#000;border:1px solid rgba(255,157,46,.4);box-shadow:0 10px 30px rgba(0,0,0,.6);display:none}
    #cmd input{width:100%;box-sizing:border-box;background:#0a0a0a;border:0;color:var(--amber);padding:12px 10px;font:14px ui-monospace, monospace;border-bottom:1px solid rgba(255,157,46,.25)}
    #cmd ul{list-style:none;margin:0;padding:6px 8px;max-height:50vh;overflow:auto}
    #cmd li{padding:6px 4px;border-bottom:1px dashed rgba(255,157,46,.2)}
    .pill{border:1px solid rgba(255,157,46,.4); padding:2px 6px; border-radius:999px; font-size:11px; opacity:.8}
  </style>
</head>
<body>
  <div id="wrap">
    <div id="stage">
      <canvas id="lowres"></canvas>
      <canvas id="hires"></canvas>
      <div id="scanlines"></div>
      <div id="hints">[Space]=Pause • [S]=Screenshot • [/]=Commands • [1]=Inspector • [2]=Log • [3]=Comms • [4]=Timeline • [M]=Drop Marker</div>
      <div id="credits">MAGPIE // SIGNAL-TRACE</div>

      <div class="win" id="win-inspector" style="left:14px; top:60px; display:block">
        <div class="title"><b>NODE INSPECTOR</b><div class="actions"><span id="audioState" class="pill">audio: off</span><button data-close="win-inspector">×</button></div></div>
        <div class="body mono" id="inspector-body">booting…</div>
      </div>
      <div class="win" id="win-log" style="right:14px; top:60px; width:380px; display:block">
        <div class="title"><b>INCIDENT LOG</b><div class="actions"><button data-close="win-log">×</button></div></div>
        <div class="body mono" id="log-body">— boot
— linking sensor bus
— syncing field integrator
— listening…</div>
      </div>
      <div class="win" id="win-comms" style="left:14px; bottom:72px; width:420px; display:none">
        <div class="title"><b>COMMS</b><div class="actions"><button data-close="win-comms">×</button></div></div>
        <div class="body mono">
          <div class="tabs">
            <button data-tab="baun">Baun</button>
            <button data-tab="cassie">Cassie</button>
            <button data-tab="mero">Mero</button>
          </div>
          <div id="tab-baun">[BAUN] overlay up. if the tear crosses the ridge again, lock it.
> set threshold 0.78
> arm quarantine route R-13
</div>
          <div id="tab-cassie" style="display:none">[CASSIE] cadence repeats every 13.4s but breath is off. watching.
> triangulate // pulse-verify
</div>
          <div id="tab-mero" style="display:none">[MERO] those aren’t artifacts, they’re recalls. whoever this is— they want us to remember.
> drop a marker at the quiet node
</div>
        </div>
      </div>
      <div class="win" id="win-time" style="right:14px; bottom:72px; width:320px; display:none">
        <div class="title"><b>TIMELINE</b><div class="actions"><button data-close="win-time">×</button></div></div>
        <div class="body mono">
          t = <span id="tval">0.0</span>
          <input id="tscrub" type="range" min="0" max="200" step="0.1" value="0" style="width:100%">
          <div>mode: <b id="timemode">live</b> (toggle with L)</div>
        </div>
      </div>
      <div id="cmd" class="win">
        <input id="cmdin" placeholder="/ commands: toggle inspector|log|channels|timeline · glitch:x · density:x · tempo:x · snapshot · lock · unlock · mark · clear markers · goto #id · audio on|off|mute|vol:0..1"/>
        <ul id="cmdlist"></ul>
      </div>
    </div>

    <div id="panel">
      <div class="group">
        <label>Glitch</label><input id="glitch" type="range" min="0" max="1" step="0.01" value="0.18"/>
        <label>Density</label><input id="density" type="range" min="0.2" max="1.2" step="0.01" value="1.0"/>
        <label>Tempo</label><input id="tempo" type="range" min="0.2" max="2" step="0.01" value="1"/>
      </div>
      <div class="group">
        <button data-toggle="win-inspector">Inspector [1]</button>
        <button data-toggle="win-log">Log [2]</button>
        <button data-toggle="win-comms">Comms [3]</button>
        <button data-toggle="win-time">Timeline [4]</button>
        <button id="toggle">Pause</button>
        <button id="boot">Boot</button>
        <button id="shot">Capture PNG</button>
      </div>
      <div class="group">
        <label>Volume</label><input id="volume" type="range" min="0" max="1" step="0.01" value="0.5"/>
        <button id="mute">Mute</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const DPR = Math.min(window.devicePixelRatio || 1, 2);
  const stage = document.getElementById('stage');
  const s = document.getElementById('lowres');
  const v = document.getElementById('hires');
  const ctx = s.getContext('2d');
  const vtx = v.getContext('2d');

  const glitchCtl = document.getElementById('glitch');
  const densCtl   = document.getElementById('density');
  const tempoCtl  = document.getElementById('tempo');
  const toggleBtn = document.getElementById('toggle');
  const shotBtn   = document.getElementById('shot');
  const bootBtn   = document.getElementById('boot');

  // Fit canvases
  let LW=320, LH=200;
  function fit(){ const r=stage.getBoundingClientRect(); v.width=r.width*DPR; v.height=r.height*DPR; v.style.width=r.width+'px'; v.style.height=r.height+'px'; s.width=LW; s.height=LH; s.style.width=r.width+'px'; s.style.height=r.height+'px'; vtx.imageSmoothingEnabled=false; }
  window.addEventListener('resize', fit, {passive:true}); fit();
  if(stage.getBoundingClientRect().height < 50){ setTimeout(()=>{ window.dispatchEvent(new Event('resize')); }, 80); }

  // Draggable windows
  const wins = ['win-inspector','win-log','win-comms','win-time'];
  wins.forEach(id=>{
    const el=document.getElementById(id);
    const title=el.querySelector('.title');
    let ox=0,oy=0,drag=false;
    title.addEventListener('pointerdown',e=>{drag=true;title.classList.add('dragging');ox=e.clientX-el.offsetLeft;oy=e.clientY-el.offsetTop;el.setPointerCapture(e.pointerId)});
    title.addEventListener('pointermove',e=>{if(!drag)return; const nx=Math.min(window.innerWidth-el.offsetWidth-6,Math.max(6,e.clientX-ox)); const ny=Math.min(window.innerHeight-220,Math.max(40,e.clientY-oy)); el.style.left=nx+'px'; el.style.top=ny+'px';});
    title.addEventListener('pointerup',()=>{drag=false;title.classList.remove('dragging');});
    el.querySelectorAll('[data-close]')?.forEach(btn=>btn.addEventListener('click',()=>{el.style.display='none'}));
    document.querySelector(`[data-toggle="${id}"]`)?.addEventListener('click',()=>{ el.style.display=(el.style.display==='none'||!el.style.display)?'block':'none'});
  });

  // Noise + field (robust)
  const seed=(Math.random()*1e9)>>>0;
  function hash(x,y,t){ let h=x*374761393+y*668265263+(t|0)*69069+seed; h=(h^(h>>>13))*1274126177; return ((h^(h>>>16))>>>0)/4294967295; }
  function smoothstep(a){return a*a*(3-2*a)}
  function valueNoise(x,y,t){ const xi=Math.floor(x), yi=Math.floor(y); const xf=x-xi, yf=y-yi; const h00=hash(xi,yi,t), h10=hash(xi+1,yi,t), h01=hash(xi,yi+1,t), h11=hash(xi+1,yi+1,t); const u=smoothstep(xf), v=smoothstep(yf); const x1=h00*(1-u)+h10*u; const x2=h01*(1-u)+h11*u; return x1*(1-v)+x2*v; }
  function fbm(x,y,t){ let a=0,f=1,amp=0.65; for(let o=0;o<5;o++){ a+=valueNoise(x*f,y*f,t)*amp; f*=1.9; amp*=0.5;} return a; }
  function field(x,y,t){ return fbm(x*0.015,y*0.015,t*0.08); }
  function curl(x,y,t){ const e=0.5; const n1=field(x,y+e,t), n2=field(x,y-e,t), n3=field(x+e,y,t), n4=field(x-e,y,t); return {x:(n2-n1), y:(n3-n4)}; }
  function nodeStrength(x,y,t){ const f0=field(x,y,t), f1=field(x+1.7,y+0.9,t), f2=field(x-1.3,y-0.6,t); const agree=1.0-Math.abs(f0-(f1+f2)*0.5); return Math.pow(Math.max(0,agree),2.2); }
  function glitchMask(x,y,t){ const g=((x-y*1.05)*0.01 + t*0.6)%6.28318; let m=Math.sin(g)*0.5+0.5; return Math.pow(m,8.0); }
  function amber(a){ a=Math.min(1,Math.max(0,a)); const r=0.6+0.4*a, g=0.25+0.6*a, b=0.0+0.05*a; return [r*255,g*255,b*255,255]; }

  // Use createImageData once (fixes Safari getImageData oddities)
  const img = ctx.createImageData(LW, LH);
  const data = img.data;

  function drawField(t, glitchAmt, density){
    let bx=LW>>1, by=LH>>1, bv=-1;
    let i=0;
    for(let y=0;y<LH;y++){
      for(let x=0;x<LW;x++){
        const n = fbm(x*0.015,y*0.015,t*0.08);
        const f0=field(x,y,t), f1=field(x+1.7,y+0.9,t), f2=field(x-1.3,y-0.6,t);
        const sN = Math.pow(Math.max(0, 1.0 - Math.abs(f0 - (f1+f2)*0.5)), 2.2);
        const m = glitchMask(x,y,t) * glitchAmt;
        let I = 0.72*n + 1.05*sN*density - m*0.6; I = Math.max(0, Math.min(1, I));
        if(sN>bv){ bv=sN; bx=x; by=y; }
        const c=amber(I); data[i++]=c[0]; data[i++]=c[1]; data[i++]=c[2]; data[i++]=255;
      }
    }
    ctx.putImageData(img,0,0);
    return {bx,by,bv};
  }

  function drawGrid(t){
    ctx.globalAlpha=0.25; ctx.strokeStyle='rgba(120,255,120,0.6)'; ctx.lineWidth=0.5; const step=16;
    for(let gx=0; gx<LW; gx+=step){ ctx.beginPath(); for(let y=0;y<LH;y+=2){ const p=curl(gx,y,t*0.8); const wx=gx+p.x*10.0; if(y===0) ctx.moveTo(wx,y); else ctx.lineTo(wx,y);} ctx.stroke(); }
    for(let gy=0; gy<LH; gy+=step){ ctx.beginPath(); for(let x=0;x<LW;x+=2){ const p=curl(x,gy,t*0.8); const wy=gy+p.y*10.0; if(x===0) ctx.moveTo(x,wy); else ctx.lineTo(x,wy);} ctx.stroke(); }
    ctx.globalAlpha=1;
  }

  // Markers (simplified for this build)
  const markers=[]; let markerId=1; let autoCooldown=0;
  function addMarker(x,y){ markers.push({id:markerId++,x,y}); }
  function drawMarkers(){ for(const m of markers){ ctx.save(); ctx.strokeStyle='rgba(255,157,46,0.95)'; ctx.lineWidth=1; ctx.beginPath(); ctx.arc(m.x,m.y,4,0,Math.PI*2); ctx.stroke(); ctx.restore(); } }

  // Loop with multiple kickers
  let running=true, t0=performance.now();
  function frame(ts){
    if(!running) return;
    const t = (ts - t0) * 0.001 * parseFloat(tempoCtl.value);
    const g = parseFloat(glitchCtl.value), d = parseFloat(densCtl.value);
    const best = drawField(t,g,d);
    drawGrid(t);
    // crosshair
    ctx.globalAlpha=0.9; ctx.strokeStyle='rgba(255,157,46,0.9)'; ctx.beginPath(); ctx.moveTo(best.bx-12,best.by); ctx.lineTo(best.bx+12,best.by); ctx.stroke(); ctx.beginPath(); ctx.moveTo(best.bx,best.by-12); ctx.lineTo(best.bx,best.by+12); ctx.stroke(); ctx.globalAlpha=1;
    drawMarkers();

    // present
    const r=stage.getBoundingClientRect(); v.width=r.width*DPR; v.height=r.height*DPR; vtx.imageSmoothingEnabled=false; vtx.drawImage(s,0,0,v.width,v.height);
    requestAnimationFrame(frame);
  }

  function boot(){ running=true; requestAnimationFrame(frame); }
  requestAnimationFrame(frame);
  // setInterval kicker for browsers throttling RAF
  setInterval(()=>{ if(!running) return; const ts=performance.now(); frame(ts); }, 1000/12);

  // UI bindings
  toggleBtn.onclick=()=>{ running=!running; toggleBtn.textContent = running? 'Pause':'Play'; if(running) requestAnimationFrame(frame); };
  shotBtn.onclick=()=>{ const a=document.createElement('a'); a.download='magpie_signal_field.png'; a.href=v.toDataURL('image/png'); a.click(); };
  bootBtn.onclick=boot;
})();
</script>
</body>
</html>