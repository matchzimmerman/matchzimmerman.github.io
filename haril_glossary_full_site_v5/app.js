const PALETTES=[["hsl(240 28% 6%)","hsl(35 12% 95%)","hsl(265 85% 72%)","hsl(200 90% 70%)","hsl(240 8% 50%)","hsl(265 90% 65% / 0.25)"],["hsl(210 25% 6%)","hsl(20 14% 94%)","hsl(195 85% 70%)","hsl(160 80% 72%)","hsl(210 8% 52%)","hsl(195 90% 65% / 0.25)"],["hsl(260 28% 6%)","hsl(40 12% 96%)","hsl(300 80% 72%)","hsl(260 90% 70%)","hsl(260 8% 52%)","hsl(300 90% 65% / 0.25)"],["hsl(230 28% 6%)","hsl(45 12% 95%)","hsl(45 90% 68%)","hsl(15 80% 70%)","hsl(230 8% 52%)","hsl(45 90% 55% / 0.25)"]];let paletteIndex=0;function applyPalette(i){const [bg,fg,a1,a2,mut,ring]=PALETTES[i%PALETTES.length];const root=document.documentElement.style;root.setProperty('--bg',bg);root.setProperty('--fg',fg);root.setProperty('--accent',a1);root.setProperty('--accent2',a2);root.setProperty('--muted',mut);root.setProperty('--ring',ring);}applyPalette(paletteIndex);document.getElementById('paletteBtn').addEventListener('click',()=>{paletteIndex=(paletteIndex+1)%PALETTES.length;applyPalette(paletteIndex)});
const sky=document.getElementById('sky'),sctx=sky.getContext('2d');let SW=0,SH=0,SDPR=Math.min(devicePixelRatio||1,2);function fitSky(){SW=sky.width=Math.floor(innerWidth*SDPR);SH=sky.height=Math.floor(innerHeight*SDPR);sky.style.width=innerWidth+'px';sky.style.height=innerHeight+'px';drawStars()}const STARS=[];function seedStars(){STARS.length=0;const count=Math.floor((innerWidth*innerHeight)/9000);for(let i=0;i<count;i++){STARS.push({x:Math.random()*SW,y:Math.random()*SH,r:Math.random()*1.2+.2,a:Math.random()*Math.PI*2,tw:Math.random()*0.8+0.2})}}function drawStars(){sctx.clearRect(0,0,SW,SH);sctx.fillStyle='white';for(const s of STARS){const tw=0.85+0.15*Math.sin(s.a+=s.tw*0.03);sctx.globalAlpha=0.5+0.5*tw;sctx.beginPath();sctx.arc(s.x,s.y,s.r*SDPR,0,Math.PI*2);sctx.fill()}sctx.globalAlpha=1}fitSky();seedStars();drawStars();addEventListener('resize',()=>{fitSky();seedStars();drawStars()});
const cvs=document.getElementById('spiral'),ctx=cvs.getContext('2d');let W=0,H=0,DPR=Math.min(devicePixelRatio||1,2),CX=0,CY=0;function fit(){W=cvs.width=Math.floor(innerWidth*DPR);H=cvs.height=Math.floor(innerHeight*DPR);cvs.style.width=innerWidth+'px';cvs.style.height=innerHeight+'px';CX=W/2;CY=H/2}fit();addEventListener('resize',fit);let mouse={x:0,y:0};addEventListener('mousemove',e=>{mouse.x=(e.clientX/innerWidth-0.5)*2;mouse.y=(e.clientY/innerHeight-0.5)*2},{passive:true});let a=2,b=0.15,thetaStep=0.18;const MAX_POINTS=800;function draw(now){drawStars();ctx.clearRect(0,0,W,H);const wobble=30*DPR,cX=CX+wobble*mouse.x,cY=CY+wobble*mouse.y;ctx.lineWidth=Math.max(1,DPR*0.7);ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--ring');ctx.beginPath();let theta=0,first=true,spin=now*0.00012;while(theta<26){const rad=a*Math.exp(b*theta)*3.5*DPR,x=cX+Math.cos(theta+spin)*rad,y=cY+Math.sin(theta+spin)*rad;if(first){ctx.moveTo(x,y);first=false}else{ctx.lineTo(x,y)}theta+=0.08}ctx.stroke();const accent=getComputedStyle(document.documentElement).getPropertyValue('--accent'),accent2=getComputedStyle(document.documentElement).getPropertyValue('--accent2');theta=0;let i=0;while(i<MAX_POINTS){const rad=a*Math.exp(b*theta)*3.5*DPR,x=cX+Math.cos(theta+spin)*rad,y=cY+Math.sin(theta+spin)*rad;if(!(x<-50||x>W+50||y<-50||y>H+50)){ctx.beginPath();ctx.fillStyle=i%2?accent:accent2;const size=0.5+1.2*Math.pow(i/MAX_POINTS,0.45);ctx.globalAlpha=0.4+0.4*Math.sin(now*0.003+i);ctx.arc(x,y,size*DPR,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1}theta+=thetaStep;i++}requestAnimationFrame(draw)}matchMedia('(prefers-reduced-motion: reduce)').matches||requestAnimationFrame(draw);
const SECTION_INFO={recursive:{title:'Recursive / Process',desc:'Looped methods that compress noise and converge on intent.'},telemetry:{title:'Telemetry / Diagnostics',desc:'Measures that make alignment visible and actionable.'},agency:{title:'Agency & Drift',desc:'Where systems act across time/tools — and where they slip.'},identity:{title:'Identity & Cognition',desc:'From surface style to reasoning identity and cognitive mirrors.'}};let TERMS=[];const sectionsEl=document.getElementById('sections'),detailView=document.getElementById('detailView'),termContent=document.getElementById('termContent'),closeBtn=document.getElementById('closeDetail');
function cardFor(t){const el=document.createElement('article');el.className='card';el.role='listitem';el.tabIndex=0;el.dataset.slug=t.slug;const tags=(t.tags||[]).map(x=>`<a class="tag" href="#/theme/${encodeURIComponent(x)}">${x}</a>`).join('');el.innerHTML=`<h2 class="card-title">${t.title}</h2><p class="card-sub">${t.subtitle||''}</p><div class="taglist">${tags}</div>`;el.addEventListener('click',e=>{if(e.target?.classList?.contains('tag'))return;navigateTo(t.slug)});el.addEventListener('keypress',e=>{'Enter'===e.key&&navigateTo(t.slug)});return el}
function renderSections(filterTag=null){sectionsEl.innerHTML='';const buckets={recursive:[],telemetry:[],agency:[],identity:[]};(filterTag?TERMS.filter(t=>(t.tags||[]).includes(filterTag)):TERMS).forEach(t=>{const tag=(t.tags&&t.tags[0])||'misc';buckets[tag]&&buckets[tag].push(t)});const order=filterTag?[filterTag]:Object.keys(buckets);order.forEach(tag=>{const list=buckets[tag];if(!list||!list.length)return;const sec=document.createElement('section');sec.className='section';sec.id=`sec-${tag}`;const h=document.createElement('h3');h.textContent=SECTION_INFO[tag]?.title||tag;const d=document.createElement('p');d.className='desc';d.textContent=SECTION_INFO[tag]?.desc||'';const grid=document.createElement('div');grid.className='grid';list.forEach(t=>grid.appendChild(cardFor(t)));sec.appendChild(h);sec.appendChild(d);sec.appendChild(grid);sectionsEl.appendChild(sec)})}
function navigateTo(slug){location.hash=`#/term/${slug}`}
function showGrid(){detailView.hidden=true;document.body.classList.remove('has-detail')}
function showDetail(slug){detailView.hidden=false;document.body.classList.add('has-detail');termContent.innerHTML='<p style="opacity:.7">Loading…</p>';fetch(`terms/${slug}.html`,{cache:'no-store'}).then(r=>r.ok?r.text():Promise.reject()).then(html=>{termContent.innerHTML=html}).catch(()=>{termContent.innerHTML=`<h2>${slug}</h2><p>Content not found. Create <code>terms/${slug}.html</code>.</p>`})}
function closeDetail(){history.back();if('#/'===location.hash||''===location.hash)showGrid()}closeBtn.addEventListener('click',closeDetail);detailView.addEventListener('click',e=>{e.target===detailView&&closeDetail()});addEventListener('keydown',e=>{'Escape'===e.key&&closeDetail()});
function route(hash){const themeMatch=hash.match(/^#\\/theme\\/([^\\/]+)/),termMatch=hash.match(/^#\\/term\\/([\\w\\-]+)/);if(termMatch){showDetail(termMatch[1]);return}showGrid();if(themeMatch){renderSections(decodeURIComponent(themeMatch[1]));return}renderSections(null)}
fetch('terms.json',{cache:'no-store'}).then(r=>r.json()).then(d=>{TERMS=d;route(location.hash||'#/')});addEventListener('hashchange',()=>route(location.hash));
